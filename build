#!/bin/bash

BASE=$(cd $(dirname ${BASH_SOURCE[0]}); pwd)

PACKAGES=()
TARGETS=()

bail() {
  echo >&2
  echo >&2 "FAIL!"
  echo >&2 $*
  echo >&2
  exit 2
}

while [[ $# != 0 ]]; do
  case "${1}" in
  (all)
    PACKAGES+=( ctap )
    PACKAGES+=( libhiredis )
    PACKAGES+=( libsodium )
    PACKAGES+=( libzmq )
    PACKAGES+=( libvigor )
    PACKAGES+=( rrdtool )
    PACKAGES+=( bolo )
    ;;
  (ctap|libhiredis|libsodium|libvigor|libzmq|rrdtool|bolo)
    PACKAGES+=( $1 )
    ;;
  (*/*)
    TARGETS+=( $1 )
    ;;
  (ubuntu)
    TARGETS+=( debuild/precise )
    TARGETS+=( debuild/trusty )
    TARGETS+=( debuild/vivid )
    ;;
  (centos)
    TARGETS+=( rpmbuild/centos5 )
    TARGETS+=( rpmbuild/centos6 )
    TARGETS+=( rpmbuild/centos7 )
    ;;
  (precise|trusty|vivid)
    TARGETS+=( "debuild/${1}" )
    ;;
  (centos5|centos6|centos7)
    TARGETS+=( "rpmbuild/${1}" )
    ;;
  esac
  shift
done

if [[ ${#PACKAGES[@]} == 0 ]]; then
  cat <<END

You must specify what packages you want to build:

  ctap          Test Anything Protocol for C

  libsodium     Modern Crypto Library (used by libzmq)

  libzmq        Distributed Messaging Library (used by libvigor)

  libvigor      C - The Missing Bits

  bolo          A Monitoring System Toolkit

END
  exit 1
fi
if [[ ${#TARGETS[@]} == 0 ]]; then
  echo "using default targets"
  TARGETS=(debuild/{precise,trusty,vivid} rpmbuild/centos{5,6,7})
fi

for package in ${PACKAGES[@]}; do
  for target in ${TARGETS[@]}; do
    echo "building ${package} in ${target}"
    docker run -it \
      -v ${BASE}/${package}:/srv \
      -v ${BASE}/pub:/pub \
      ${target}:latest \
      || \
        bail "unable to build ${BASE}/${package} in ${target}"
    echo; echo; echo; echo;
  done
done
